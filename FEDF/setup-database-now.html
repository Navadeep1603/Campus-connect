<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Supabase Database - Campus Connect</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 15px; margin: 15px 0; border-radius: 8px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button { padding: 12px 24px; margin: 10px 5px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.danger { background: #dc3545; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 14px; }
        .step { background: #e9ecef; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #007bff; }
        .step h3 { margin-top: 0; color: #007bff; }
        .progress { width: 100%; background: #e9ecef; border-radius: 10px; height: 20px; margin: 10px 0; }
        .progress-bar { height: 100%; background: #007bff; border-radius: 10px; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Campus Connect Database Setup</h1>
        <p>This tool will automatically set up your Supabase database for Campus Connect.</p>
        
        <div class="progress">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
        
        <div id="status"></div>
        
        <button onclick="setupDatabase()" class="success">üîß Setup Database Automatically</button>
        <button onclick="testConnection()">üîó Test Connection</button>
        <button onclick="createTestAccount()">üë§ Create Test Account</button>
        
        <div id="results"></div>
        
        <div class="step">
            <h3>üìã Manual Setup (If Automatic Fails)</h3>
            <p>If the automatic setup doesn't work, copy this SQL to your Supabase SQL Editor:</p>
            <pre id="manualSQL">-- Loading SQL...</pre>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://zqnfxzqkmtiarbmdduyq.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxbmZ4enFrbXRpYXJibWRkdXlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NTAwMDUsImV4cCI6MjA3NTUyNjAwNX0.fMmEyIpcrVeKz9bYQSifxn4mtHe6hLmwEofg8avBBG8'
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%'
        }

        function log(message, type = 'info') {
            const div = document.createElement('div')
            div.className = `status ${type}`
            div.innerHTML = message
            document.getElementById('results').appendChild(div)
            console.log(message)
        }

        function clearResults() {
            document.getElementById('results').innerHTML = ''
            updateProgress(0)
        }

        async function setupDatabase() {
            clearResults()
            log('üöÄ Starting automatic database setup...', 'info')
            updateProgress(10)

            try {
                // Step 1: Test connection
                log('üì° Testing Supabase connection...', 'info')
                const { data: testData, error: testError } = await supabase.from('profiles').select('count').limit(1)
                
                if (testError && !testError.message.includes('relation "public.profiles" does not exist')) {
                    throw new Error(`Connection failed: ${testError.message}`)
                }
                
                updateProgress(20)
                log('‚úÖ Supabase connection successful!', 'success')

                // Step 2: Create profiles table
                log('üìã Creating profiles table...', 'info')
                await createTable('profiles', `
                    CREATE TABLE IF NOT EXISTS public.profiles (
                        id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
                        college_id VARCHAR(50) UNIQUE NOT NULL,
                        first_name VARCHAR(100) NOT NULL,
                        last_name VARCHAR(100) NOT NULL,
                        email VARCHAR(255) UNIQUE NOT NULL,
                        role TEXT NOT NULL DEFAULT 'student',
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    );
                `)
                updateProgress(40)

                // Step 3: Create clubs table
                log('üè¢ Creating clubs table...', 'info')
                await createTable('clubs', `
                    CREATE TABLE IF NOT EXISTS public.clubs (
                        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                        name VARCHAR(200) NOT NULL,
                        category TEXT NOT NULL,
                        faculty VARCHAR(200),
                        description TEXT,
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    );
                `)
                updateProgress(60)

                // Step 4: Create events table
                log('üìÖ Creating events table...', 'info')
                await createTable('events', `
                    CREATE TABLE IF NOT EXISTS public.events (
                        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                        title VARCHAR(300) NOT NULL,
                        club_id UUID REFERENCES public.clubs(id) ON DELETE CASCADE,
                        venue VARCHAR(200) NOT NULL,
                        start_time TIMESTAMP WITH TIME ZONE NOT NULL,
                        end_time TIMESTAMP WITH TIME ZONE NOT NULL,
                        category TEXT NOT NULL,
                        capacity INTEGER DEFAULT 50,
                        description TEXT,
                        created_by UUID REFERENCES public.profiles(id),
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    );
                `)
                updateProgress(70)

                // Step 5: Create event_registrations table
                log('üìù Creating event_registrations table...', 'info')
                await createTable('event_registrations', `
                    CREATE TABLE IF NOT EXISTS public.event_registrations (
                        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                        event_id UUID REFERENCES public.events(id) ON DELETE CASCADE,
                        student_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
                        status TEXT NOT NULL DEFAULT 'pending',
                        registered_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        UNIQUE(event_id, student_id)
                    );
                `)
                updateProgress(80)

                // Step 5: Setup RLS and policies
                log('üîí Setting up security policies...', 'info')
                await setupSecurity()
                updateProgress(90)

                // Step 6: Insert sample data
                log('üìä Inserting sample data...', 'info')
                await insertSampleData()
                updateProgress(100)

                log('üéâ Database setup completed successfully!', 'success')
                log('‚úÖ Your Campus Connect app is now ready to use with cloud storage!', 'success')

            } catch (error) {
                log(`‚ùå Setup failed: ${error.message}`, 'error')
                log('üí° Try the manual setup below or contact support.', 'warning')
            }
        }

        async function createTable(tableName, sql) {
            try {
                const { error } = await supabase.rpc('exec_sql', { sql_query: sql })
                if (error) {
                    // If RPC doesn't work, the table might already exist
                    log(`‚ö†Ô∏è ${tableName} table: ${error.message}`, 'warning')
                } else {
                    log(`‚úÖ ${tableName} table created successfully`, 'success')
                }
            } catch (error) {
                log(`‚ö†Ô∏è ${tableName} table creation: ${error.message}`, 'warning')
            }
        }

        async function setupSecurity() {
            const policies = [
                "ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;",
                "ALTER TABLE public.clubs ENABLE ROW LEVEL SECURITY;",
                "ALTER TABLE public.events ENABLE ROW LEVEL SECURITY;",
                "ALTER TABLE public.event_registrations ENABLE ROW LEVEL SECURITY;",
                "CREATE POLICY IF NOT EXISTS \"Anyone can create a profile\" ON public.profiles FOR INSERT WITH CHECK (true);",
                "CREATE POLICY IF NOT EXISTS \"Users can view their own profile\" ON public.profiles FOR SELECT USING (auth.uid() = id);",
                "CREATE POLICY IF NOT EXISTS \"Anyone can view clubs\" ON public.clubs FOR SELECT USING (true);",
                "CREATE POLICY IF NOT EXISTS \"Anyone can view events\" ON public.events FOR SELECT USING (true);",
                "CREATE POLICY IF NOT EXISTS \"Students can register for events\" ON public.event_registrations FOR INSERT WITH CHECK (auth.uid() = student_id);",
                "CREATE POLICY IF NOT EXISTS \"Users can view their registrations\" ON public.event_registrations FOR SELECT USING (auth.uid() = student_id);"
            ]

            for (const policy of policies) {
                try {
                    await supabase.rpc('exec_sql', { sql_query: policy })
                } catch (error) {
                    log(`‚ö†Ô∏è Security policy: ${error.message}`, 'warning')
                }
            }
        }

        async function insertSampleData() {
            try {
                const { error } = await supabase.from('clubs').upsert([
                    { id: 'c1c1c1c1-c1c1-c1c1-c1c1-c1c1c1c1c1c1', name: 'Robotics Club', category: 'STEM', faculty: 'Dr. Lee', description: 'Build and program robots.' },
                    { id: 'c2c2c2c2-c2c2-c2c2-c2c2-c2c2c2c2c2c2', name: 'Drama Society', category: 'Arts', faculty: 'Ms. Patel', description: 'Theater and performance.' },
                    { id: 'c3c3c3c3-c3c3-c3c3-c3c3-c3c3c3c3c3c3', name: 'Eco Warriors', category: 'Community', faculty: 'Mr. Gomez', description: 'Sustainability initiatives.' }
                ])
                
                if (error) {
                    log(`‚ö†Ô∏è Sample data: ${error.message}`, 'warning')
                } else {
                    log('‚úÖ Sample clubs inserted', 'success')
                }
            } catch (error) {
                log(`‚ö†Ô∏è Sample data insertion: ${error.message}`, 'warning')
            }
        }

        async function testConnection() {
            clearResults()
            log('üîó Testing connection to Supabase...', 'info')
            
            try {
                const { data, error } = await supabase.from('profiles').select('count').limit(1)
                
                if (error) {
                    if (error.message.includes('relation "public.profiles" does not exist')) {
                        log('‚ö†Ô∏è Profiles table does not exist. Run database setup first.', 'warning')
                    } else {
                        log(`‚ùå Connection error: ${error.message}`, 'error')
                    }
                } else {
                    log('‚úÖ Connection successful! Database is ready.', 'success')
                }
            } catch (error) {
                log(`üí• Connection failed: ${error.message}`, 'error')
            }
        }

        async function createTestAccount() {
            clearResults()
            log('üë§ Creating test account...', 'info')
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: '2400030987@kluniversity.in',
                    password: 'test123456',
                    options: {
                        emailRedirectTo: undefined,
                        data: { email_confirm: true }
                    }
                })
                
                if (error) {
                    log(`‚ùå Account creation failed: ${error.message}`, 'error')
                } else {
                    log('‚úÖ Test account created successfully!', 'success')
                    log(`üìß Email: 2400030987@kluniversity.in`, 'info')
                    log(`üîë Password: test123456`, 'info')
                    
                    // Create profile
                    if (data.user) {
                        const { error: profileError } = await supabase.from('profiles').insert({
                            id: data.user.id,
                            college_id: '2400030987',
                            first_name: 'Challa',
                            last_name: 'Navadeep',
                            email: '2400030987@kluniversity.in',
                            role: 'student'
                        })
                        
                        if (profileError) {
                            log(`‚ö†Ô∏è Profile creation: ${profileError.message}`, 'warning')
                        } else {
                            log('‚úÖ Profile created successfully!', 'success')
                        }
                    }
                }
            } catch (error) {
                log(`üí• Account creation failed: ${error.message}`, 'error')
            }
        }

        // Load manual SQL
        document.getElementById('manualSQL').textContent = `-- Campus Connect Database Setup - Complete
-- Run this in your Supabase SQL Editor

-- 1. Create profiles table
CREATE TABLE IF NOT EXISTS public.profiles (
    id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    college_id VARCHAR(50) UNIQUE NOT NULL,
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    role TEXT NOT NULL DEFAULT 'student',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. Create clubs table
CREATE TABLE IF NOT EXISTS public.clubs (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    category TEXT NOT NULL,
    faculty VARCHAR(200),
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. Create events table
CREATE TABLE IF NOT EXISTS public.events (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    title VARCHAR(300) NOT NULL,
    club_id UUID REFERENCES public.clubs(id) ON DELETE CASCADE,
    venue VARCHAR(200) NOT NULL,
    start_time TIMESTAMP WITH TIME ZONE NOT NULL,
    end_time TIMESTAMP WITH TIME ZONE NOT NULL,
    category TEXT NOT NULL,
    capacity INTEGER DEFAULT 50,
    description TEXT,
    created_by UUID REFERENCES public.profiles(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. Create event_registrations table
CREATE TABLE IF NOT EXISTS public.event_registrations (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    event_id UUID REFERENCES public.events(id) ON DELETE CASCADE,
    student_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    status TEXT NOT NULL DEFAULT 'pending',
    registered_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(event_id, student_id)
);

-- 5. Enable Row Level Security
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.clubs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.events ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.event_registrations ENABLE ROW LEVEL SECURITY;

-- 6. Create security policies
CREATE POLICY IF NOT EXISTS "Anyone can create a profile" ON public.profiles
    FOR INSERT WITH CHECK (true);

CREATE POLICY IF NOT EXISTS "Users can view their own profile" ON public.profiles
    FOR SELECT USING (auth.uid() = id);

CREATE POLICY IF NOT EXISTS "Anyone can view clubs" ON public.clubs
    FOR SELECT USING (true);

CREATE POLICY IF NOT EXISTS "Anyone can view events" ON public.events
    FOR SELECT USING (true);

CREATE POLICY IF NOT EXISTS "Students can register for events" ON public.event_registrations
    FOR INSERT WITH CHECK (auth.uid() = student_id);

CREATE POLICY IF NOT EXISTS "Users can view their registrations" ON public.event_registrations
    FOR SELECT USING (auth.uid() = student_id);

-- 7. Insert sample clubs
INSERT INTO public.clubs (id, name, category, faculty, description) VALUES
    ('c1c1c1c1-c1c1-c1c1-c1c1-c1c1c1c1c1c1', 'Robotics Club', 'STEM', 'Dr. Lee', 'Build and program robots.'),
    ('c2c2c2c2-c2c2-c2c2-c2c2-c2c2c2c2c2c2', 'Drama Society', 'Arts', 'Ms. Patel', 'Theater and performance.'),
    ('c3c3c3c3-c3c3-c3c3-c3c3-c3c3c3c3c3c3', 'Eco Warriors', 'Community', 'Mr. Gomez', 'Sustainability initiatives.')
ON CONFLICT (id) DO NOTHING;`
    </script>
</body>
</html>
